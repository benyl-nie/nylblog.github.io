<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>vue3+node(koa)实现微信自定义分享 | 玉玲～</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">vue3+node(koa)实现微信自定义分享</h1><a id="logo" href="/.">玉玲～</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">vue3+node(koa)实现微信自定义分享</h1><div class="post-meta">May 23, 2020</div><div class="post-content"><p>基于 h5 (vue) node(koa2) 微信jssdk实现的微信自定义分享<br><a id="more"></a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近团队有个需求，需要h5在微信中打开然后分享给同事或者朋友圈的时候自定义微信分享图标，标题等，即将如下的图片1做成图片2的形式<br><img src="/img/wx-share/share_01.jpg" alt="图片1"><br><img src="/img/wx-share/share_02.jpg" alt="图片2"></p>
<h3 id="实现方案"><a href="#实现方案" class="headerlink" title="实现方案"></a>实现方案</h3><h4 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h4><pre><code>- 微信sdk官方文档(http://caibaojian.com/wxwiki/0030551f015f01ecaa56d20b88ee3c6cb32503bf.html)
- 团队公众号
- 服务器域名
- 准备
  * 公众号设置，功能设置,配置安全域名
    ![功能设置](/img/wx-share/share_03.jpg)
  * 开发，开通开发者功能，配置ip白名单（包含自己本地机器，测试环境机器）
- 代码方案
  * node层开启8411端口，package.json 中引入 concurrently同时启动客户端和服务端，vue3 开启到 8411 端口

  package.json

  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"dev"</span>: <span class="string">"concurrently \"npm run client\" \"npm run server\" --color "</span>,</span><br></pre></td></tr></table></figure>

  vue.config.js

  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'/wechat'</span>: &#123;</span><br><span class="line">        <span class="comment">// target: 'http://[::1]:8411',</span></span><br><span class="line">    target: <span class="string">'http://127.0.0.1:8411'</span>,</span><br><span class="line">    changeOrigin: <span class="literal">true</span>,</span><br><span class="line">    wx: <span class="literal">true</span>,</span><br><span class="line">    pathRewrite: &#123;</span><br><span class="line">      <span class="string">'^/wechat'</span>: <span class="string">'/wechat'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  * 在node层按照jssdk微信公众平台的方案用koa2,koa-router写一个接口，监听8411端口

  server/index.js

  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> staticFiles = <span class="built_in">require</span>(<span class="string">'koa-static'</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)</span><br><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">'koa-cors'</span>)</span><br><span class="line"><span class="keyword">const</span> onerror = <span class="built_in">require</span>(<span class="string">'koa-onerror'</span>) <span class="comment">//错误处理</span></span><br><span class="line"><span class="keyword">const</span> getAccess = <span class="built_in">require</span>(<span class="string">'./lib/wxAccess'</span>)</span><br><span class="line"><span class="keyword">const</span> Router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> Router();</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line">onerror(app)</span><br><span class="line"><span class="comment">// logger</span></span><br><span class="line"></span><br><span class="line">app.use(staticFiles(path.resolve(__dirname, <span class="string">"../public"</span>)))</span><br><span class="line">app.use(cors())</span><br><span class="line"></span><br><span class="line">app.use(bodyParser())</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">  <span class="keyword">const</span> rt = ctx.response.get(<span class="string">'X-Response-Time'</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;ctx.method&#125;</span> <span class="subst">$&#123;ctx.url&#125;</span> - <span class="subst">$&#123;rt&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/wechat/getConfig'</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> url = ctx.request.body.url;</span><br><span class="line">  <span class="keyword">const</span> resp = <span class="keyword">await</span> getAccess(url);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'resp in index'</span>, resp);</span><br><span class="line">  ctx.body = &#123;</span><br><span class="line">    data: resp,</span><br><span class="line">    success: <span class="literal">true</span>,</span><br><span class="line">    message: <span class="string">''</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">await</span> next();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(router.routes())</span><br><span class="line"></span><br><span class="line">app.use(router.allowedMethods())</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8411</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server is listen port:8411'</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

  /lib/wxAccess

  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sha1 = <span class="built_in">require</span>(<span class="string">'sha1'</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./wxConfig'</span>)</span><br><span class="line"><span class="keyword">const</span> cache = <span class="built_in">require</span>(<span class="string">'memory-cache'</span>)</span><br><span class="line"><span class="keyword">const</span> rp = <span class="built_in">require</span>(<span class="string">'request-promise'</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsApiList = [</span><br><span class="line">  <span class="string">'checkJsApi'</span>,</span><br><span class="line">  <span class="string">'onMenuShareTimeline'</span>,</span><br><span class="line">  <span class="string">'onMenuShareAppMessage'</span>,</span><br><span class="line">  <span class="string">'onMenuShareQQ'</span>,</span><br><span class="line">  <span class="string">'onMenuShareWeibo'</span>,</span><br><span class="line">  <span class="string">'hideMenuItems'</span>,</span><br><span class="line">  <span class="string">'showMenuItems'</span>,</span><br><span class="line">  <span class="string">'hideAllNonBaseMenuItem'</span>,</span><br><span class="line">  <span class="string">'showAllNonBaseMenuItem'</span>,</span><br><span class="line">  <span class="string">'translateVoice'</span>,</span><br><span class="line">  <span class="string">'startRecord'</span>,</span><br><span class="line">  <span class="string">'stopRecord'</span>,</span><br><span class="line">  <span class="string">'onRecordEnd'</span>,</span><br><span class="line">  <span class="string">'playVoice'</span>,</span><br><span class="line">  <span class="string">'pauseVoice'</span>,</span><br><span class="line">  <span class="string">'stopVoice'</span>,</span><br><span class="line">  <span class="string">'uploadVoice'</span>,</span><br><span class="line">  <span class="string">'downloadVoice'</span>,</span><br><span class="line">  <span class="string">'chooseImage'</span>,</span><br><span class="line">  <span class="string">'previewImage'</span>,</span><br><span class="line">  <span class="string">'uploadImage'</span>,</span><br><span class="line">  <span class="string">'downloadImage'</span>,</span><br><span class="line">  <span class="string">'getNetworkType'</span>,</span><br><span class="line">  <span class="string">'openLocation'</span>,</span><br><span class="line">  <span class="string">'getLocation'</span>,</span><br><span class="line">  <span class="string">'hideOptionMenu'</span>,</span><br><span class="line">  <span class="string">'showOptionMenu'</span>,</span><br><span class="line">  <span class="string">'closeWindow'</span>,</span><br><span class="line">  <span class="string">'scanQRCode'</span>,</span><br><span class="line">  <span class="string">'chooseWXPay'</span>,</span><br><span class="line">  <span class="string">'openProductSpecificView'</span>,</span><br><span class="line">  <span class="string">'addCard'</span>,</span><br><span class="line">  <span class="string">'chooseCard'</span>,</span><br><span class="line">  <span class="string">'openCard'</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> getAccess = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> noncestr = crypto.randomBytes(<span class="built_in">Math</span>.ceil(<span class="number">32</span> / <span class="number">2</span>)).toString(<span class="string">'hex'</span>).slice(<span class="number">0</span>, <span class="number">32</span>);;</span><br><span class="line">    <span class="keyword">const</span> timestamp = <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>); <span class="comment">//???</span></span><br><span class="line">    <span class="keyword">let</span> wxdata = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ???????????????????</span></span><br><span class="line">      <span class="keyword">if</span> (cache.get(<span class="string">'ticket'</span>)) &#123;</span><br><span class="line">        <span class="comment">// console.log('ticket in cache', cache.get('ticket'))</span></span><br><span class="line">        <span class="keyword">const</span> jsapi_ticket = cache.get(<span class="string">'ticket'</span>);</span><br><span class="line">        wxdata = &#123;</span><br><span class="line">          appId: config.wxappid,</span><br><span class="line">          noncestr,</span><br><span class="line">          timestamp,</span><br><span class="line">          url,</span><br><span class="line">          jsapi_ticket,</span><br><span class="line">          signature: sha1(<span class="string">`jsapi_ticket=<span class="subst">$&#123;jsapi_ticket&#125;</span>&amp;noncestr=<span class="subst">$&#123;noncestr&#125;</span>&amp;timestamp=<span class="subst">$&#123;timestamp&#125;</span>&amp;url=<span class="subst">$&#123;url&#125;</span>`</span>),</span><br><span class="line">          jsApiList</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> tokenMap = <span class="keyword">await</span> rp(&#123;<span class="attr">uri</span>: <span class="string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=<span class="subst">$&#123;config.wxappid&#125;</span>&amp;secret=<span class="subst">$&#123;config.wxappsecret&#125;</span>`</span>&#125;);</span><br><span class="line">        <span class="comment">// console.log('rp res', JSON.parse(tokenMap));</span></span><br><span class="line">        <span class="keyword">const</span> resp = <span class="keyword">await</span> rp(&#123;<span class="attr">uri</span>: <span class="string">`https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=<span class="subst">$&#123;<span class="built_in">JSON</span>.parse(tokenMap).access_token&#125;</span>&amp;type=jsapi`</span>&#125;);</span><br><span class="line">        <span class="keyword">const</span> ticketMap = <span class="built_in">JSON</span>.parse(resp);</span><br><span class="line">        cache.put(<span class="string">'ticket'</span>, ticketMap.ticket, (<span class="number">1000</span> * <span class="number">7200</span>));</span><br><span class="line">        <span class="keyword">var</span> resultCode = sha1(<span class="string">`jsapi_ticket=<span class="subst">$&#123;ticketMap.ticket&#125;</span>&amp;noncestr=<span class="subst">$&#123;noncestr&#125;</span>&amp;timestamp=<span class="subst">$&#123;timestamp&#125;</span>&amp;url=http://192.168.3.9:8080/sharepage/download`</span>);</span><br><span class="line">        <span class="comment">// console.log('resultCode', resultCode);</span></span><br><span class="line">        </span><br><span class="line">        wxdata = &#123;</span><br><span class="line">          appId: config.wxappid,</span><br><span class="line">          noncestr,</span><br><span class="line">          timestamp,</span><br><span class="line">          url,</span><br><span class="line">          jsapi_ticket: ticketMap.ticket,</span><br><span class="line">          signature: resultCode,</span><br><span class="line">          jsApiList</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'wx data'</span>, wxdata);</span><br><span class="line">      resolve(wxdata);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'catch exception'</span>, <span class="built_in">JSON</span>.stringify(e));</span><br><span class="line">      reject(<span class="string">'catch exception'</span>, <span class="built_in">JSON</span>.stringify(e));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = getAccess;</span><br></pre></td></tr></table></figure>

  ./wxConfig

  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  wxappid: <span class="string">'wx2389aa4213cf6e5b'</span>, <span class="comment">//AppID  </span></span><br><span class="line">  wxappsecret: <span class="string">'deec172ab3ba65ceef13a41c1218ef0e'</span>, <span class="comment">//AppSecret</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config</span><br></pre></td></tr></table></figure>

  * 前端vue引用

  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// weixin.js</span></span><br><span class="line">  <span class="keyword">import</span> wx <span class="keyword">from</span> <span class="string">'weixin-js-sdk'</span> <span class="comment">// 微信sdk依赖</span></span><br><span class="line">  <span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'@/utils/http'</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> getWxConfig = <span class="function">(<span class="params">wxConf = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!wxConf.appId) &#123;</span><br><span class="line">        reject(&#123;&#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resolve(&#123;</span><br><span class="line">          debug: <span class="literal">false</span>,</span><br><span class="line">          appId: wxConf.appId,</span><br><span class="line">          timestamp: wxConf.timestamp,</span><br><span class="line">          nonceStr: wxConf.noncestr,</span><br><span class="line">          signature: wxConf.signature,</span><br><span class="line">          jsApiList: wxConf.jsApiList</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">const</span> shareOnWx = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> url = <span class="built_in">window</span>.location.href.split(<span class="string">'#'</span>)[<span class="number">0</span>] <span class="comment">//url不能写死</span></span><br><span class="line">    <span class="comment">// console.log('url', url);</span></span><br><span class="line">    <span class="keyword">const</span> imgUrl = <span class="string">'https://iflybudstest.iflytek.com/sharepage/download/sharelogo.jpg'</span>;</span><br><span class="line">    <span class="keyword">const</span> &#123;<span class="attr">data</span>: wxConf&#125; = <span class="keyword">await</span> http(&#123;</span><br><span class="line">      url: <span class="string">`/wechat/getConfig`</span>,</span><br><span class="line">      data: &#123;url&#125;,</span><br><span class="line">      method: <span class="string">'post'</span>,</span><br><span class="line">      headers: &#123;</span><br><span class="line">        <span class="string">'Content-type'</span>: <span class="string">'application/json; charset=utf-8'</span>,</span><br><span class="line">        <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="keyword">const</span> wxConfig = <span class="keyword">await</span> getWxConfig(wxConf);</span><br><span class="line">  wx.config(wxConfig);</span><br><span class="line">  <span class="comment">// 分享给朋友</span></span><br><span class="line">  wx.ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    wx.onMenuShareAppMessage(&#123;</span><br><span class="line">      title: <span class="string">'点击下载iFLYBUDS App,通话转文字,记录更轻松'</span>, <span class="comment">// 分享标题</span></span><br><span class="line">      desc: <span class="built_in">window</span>.location.href.split(<span class="string">'?'</span>)[<span class="number">0</span>], <span class="comment">// 分享描述</span></span><br><span class="line">      link: url, <span class="comment">// 分享链接</span></span><br><span class="line">      imgUrl: <span class="string">'https://iflybudstest.iflytek.com/img/wx_logo.jpg'</span>,</span><br><span class="line">      type: <span class="string">'link'</span>, <span class="comment">// 分享类型,music、video或link，不填默认为link</span></span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 分享到朋友圈</span></span><br><span class="line">    wx.onMenuShareTimeline(&#123;</span><br><span class="line">      title: <span class="string">'点击下载iFLYBUDS App,通话转文字,记录更轻松'</span>, <span class="comment">// 分享标题</span></span><br><span class="line">      desc: <span class="built_in">window</span>.location.href.split(<span class="string">'?'</span>)[<span class="number">0</span>], <span class="comment">// 分享描述</span></span><br><span class="line">      link: url, <span class="comment">// 分享链接</span></span><br><span class="line">      imgUrl: <span class="string">'https://iflybudstest.iflytek.com/img/wx_logo.jpg'</span>,</span><br><span class="line">      type: <span class="string">'link'</span>, <span class="comment">// 分享类型,music、video或link，不填默认为link</span></span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    wx.error(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">      alert(<span class="built_in">JSON</span>.stringify(res))</span><br><span class="line">      <span class="comment">// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre><ul>
<li><p>踩坑点</p>
<ul>
<li>vue端口不监听8411， 需要在vue.config.js中调用</li>
<li>签名出错，记得要按照微信公众平台的步骤来，可以通过<a href="https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign看签名是否正确" target="_blank" rel="noopener">https://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=jsapisign看签名是否正确</a></li>
<li>图片不展示，图片地址需要为服务器地址，并且该服务器域名为准备工作中配的js安全域名下</li>
<li><p>问题跟进</p>
<ul>
<li><p>最近把整个vue项目由history路由换成hash模式，当时好开心啊，解决了运维每次配置nginx这个问题，可是，当沉浸在开心的快乐中时，没想到，测试提出来一个问题，下载页无法分享了，分享出来再点击进去是空白了，好慌好慌啊</p>
<ul>
<li><p>问题定位：<br>1、vue hash模式下的路径自动带#，然后微信会直接截取#后面的字符串，然后加上自己的标识字符串，这样会导致自己的vue项目无法辨别自己的vue路径，会自动跳到首页，如下：<br>原： <a href="https://iflybudstest.iflytek.com/#/download" target="_blank" rel="noopener">https://iflybudstest.iflytek.com/#/download</a><br>新： <a href="https://iflybudstest.iflytek.com/?from=singlemessage&amp;isappinstalled=0#/download" target="_blank" rel="noopener">https://iflybudstest.iflytek.com/?from=singlemessage&amp;isappinstalled=0#/download</a><br>2、如果在vue hash模式下与history模式下对微信做签名的url还是全路径的话，比如history模式下的路径是 <a href="http://192.168.3.9:8080/sharepage/download，那么在hash模式下传递到微信签名端的url只要是域名就可以了，也即是第一个#" target="_blank" rel="noopener">http://192.168.3.9:8080/sharepage/download，那么在hash模式下传递到微信签名端的url只要是域名就可以了，也即是第一个#</a> 之前的部分<br>在前端写微信分享的时候，会有两个字符串，一个是图片，一个是分享链接<br>a) 对于分享链接，因为微信会对分享的链接做#拦截，所以这里需要对分享链接做组合：如下： url + ‘#’ + window.location.href.split(‘#’)[1]<br>b) 对于分享图片，要保证图片的地址路径在域名服务器上可查找，但是试了这个方法后，分享出去的图片还是错误的，所以百度试了其他方法，在head里面加个img标签，如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img id=<span class="string">"shareImg"</span> src=<span class="string">"&lt;%= BASE_URL %&gt;sharelogo.jpg"</span> width=<span class="string">"0"</span> height=<span class="string">"0"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>然后在分享的配置图片中写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imgUrl: <span class="built_in">document</span>.getElementById(<span class="string">'shareImg'</span>).src,</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>如上，整个与微信分享从测试环境的测试与线上环境的测试已完毕，下面我把全部代码贴出，如下：<br>.vue项目中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; shareOnWx &#125; <span class="keyword">from</span> <span class="string">'../utils/wx'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    created() &#123;</span><br><span class="line">      shareOnWx();</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>wx.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// weixin.js</span></span><br><span class="line"><span class="keyword">import</span> wx <span class="keyword">from</span> <span class="string">'weixin-js-sdk'</span>; <span class="comment">// 微信sdk依赖</span></span><br><span class="line"><span class="keyword">import</span> http <span class="keyword">from</span> <span class="string">'@/utils/http'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getWxConfig = <span class="function">(<span class="params">wxConf = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!wxConf.appId) &#123;</span><br><span class="line">      reject(&#123;&#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      resolve(&#123;</span><br><span class="line">        debug: <span class="literal">false</span>,</span><br><span class="line">        appId: wxConf.appId,</span><br><span class="line">        timestamp: wxConf.timestamp,</span><br><span class="line">        nonceStr: wxConf.noncestr,</span><br><span class="line">        signature: wxConf.signature,</span><br><span class="line">        jsApiList: wxConf.jsApiList</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> shareOnWx = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> url = <span class="built_in">window</span>.location.href.split(<span class="string">'#'</span>)[<span class="number">0</span>] <span class="comment">//url不能写死</span></span><br><span class="line">  <span class="comment">// console.log('share img', `$&#123;url&#125;sharelogo.jpg`)</span></span><br><span class="line">  <span class="comment">// console.log('url', `$&#123;url&#125;?path=download`)</span></span><br><span class="line">  <span class="comment">// console.log('shareImg.src',document.getElementById('shareImg').src)</span></span><br><span class="line">  <span class="keyword">const</span> &#123;<span class="attr">data</span>: wxConf&#125; = <span class="keyword">await</span> http(&#123;</span><br><span class="line">    url: <span class="string">`/wechat/getConfig`</span>,</span><br><span class="line">    data: &#123;url&#125;,</span><br><span class="line">    method: <span class="string">'post'</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      <span class="string">'Content-type'</span>: <span class="string">'application/json; charset=utf-8'</span>,</span><br><span class="line">      <span class="string">'Accept'</span>: <span class="string">'application/json'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> wxConfig = <span class="keyword">await</span> getWxConfig(wxConf);</span><br><span class="line">  wx.config(wxConfig);</span><br><span class="line">  <span class="comment">// 分享给朋友</span></span><br><span class="line">  wx.ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;   </span><br><span class="line">    wx.onMenuShareAppMessage(&#123;</span><br><span class="line">      title: <span class="string">'点击下载iFLYBUDS App,通话转文字,记录更轻松'</span>, <span class="comment">// 分享标题</span></span><br><span class="line">      desc: <span class="built_in">window</span>.location.href.split(<span class="string">'?'</span>)[<span class="number">0</span>], <span class="comment">// 分享描述</span></span><br><span class="line">      link: url + <span class="string">'#'</span> + <span class="built_in">window</span>.location.href.split(<span class="string">'#'</span>)[<span class="number">1</span>],</span><br><span class="line">      imgUrl: <span class="built_in">document</span>.getElementById(<span class="string">'shareImg'</span>).src,</span><br><span class="line">      type: <span class="string">'link'</span>, <span class="comment">// 分享类型,music、video或link，不填默认为link</span></span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// console.log('分享给朋友 onMenuShareAppMessage', res);</span></span><br><span class="line">        <span class="comment">// 设置成功</span></span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        alert(<span class="string">'分享cancel'</span>)</span><br><span class="line">        <span class="comment">// 用户取消分享后执行的回调函数</span></span><br><span class="line">        <span class="comment">// console.log('分享给朋友cacel');</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 分享到朋友圈</span></span><br><span class="line">    wx.onMenuShareTimeline(&#123;</span><br><span class="line">      title: <span class="string">'点击下载iFLYBUDS App,通话转文字,记录更轻松'</span>, <span class="comment">// 分享标题</span></span><br><span class="line">      desc: <span class="built_in">window</span>.location.href.split(<span class="string">'?'</span>)[<span class="number">0</span>], <span class="comment">// 分享描述</span></span><br><span class="line">      link: url + <span class="string">'#'</span> + <span class="built_in">window</span>.location.href.split(<span class="string">'#'</span>)[<span class="number">1</span>], <span class="comment">// 分享链接</span></span><br><span class="line">      imgUrl: <span class="built_in">document</span>.getElementById(<span class="string">'shareImg'</span>).src,</span><br><span class="line">      type: <span class="string">'link'</span>, <span class="comment">// 分享类型,music、video或link，不填默认为link</span></span><br><span class="line">      success: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 设置成功</span></span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 用户取消分享后执行的回调函数</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    wx.error(<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">      alert(<span class="built_in">JSON</span>.stringify(res))</span><br><span class="line">      <span class="comment">// config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>node 端 .wxAccess.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sha1 = <span class="built_in">require</span>(<span class="string">'sha1'</span>)</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'./wxConfig'</span>)</span><br><span class="line"><span class="keyword">const</span> cache = <span class="built_in">require</span>(<span class="string">'memory-cache'</span>)</span><br><span class="line"><span class="keyword">const</span> rp = <span class="built_in">require</span>(<span class="string">'request-promise'</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> jsApiList = [</span><br><span class="line">  <span class="string">'checkJsApi'</span>,</span><br><span class="line">  <span class="string">'onMenuShareTimeline'</span>,</span><br><span class="line">  <span class="string">'onMenuShareAppMessage'</span>,</span><br><span class="line">  <span class="string">'onMenuShareQQ'</span>,</span><br><span class="line">  <span class="string">'onMenuShareWeibo'</span>,</span><br><span class="line">  <span class="string">'hideMenuItems'</span>,</span><br><span class="line">  <span class="string">'showMenuItems'</span>,</span><br><span class="line">  <span class="string">'hideAllNonBaseMenuItem'</span>,</span><br><span class="line">  <span class="string">'showAllNonBaseMenuItem'</span>,</span><br><span class="line">  <span class="string">'translateVoice'</span>,</span><br><span class="line">  <span class="string">'startRecord'</span>,</span><br><span class="line">  <span class="string">'stopRecord'</span>,</span><br><span class="line">  <span class="string">'onRecordEnd'</span>,</span><br><span class="line">  <span class="string">'playVoice'</span>,</span><br><span class="line">  <span class="string">'pauseVoice'</span>,</span><br><span class="line">  <span class="string">'stopVoice'</span>,</span><br><span class="line">  <span class="string">'uploadVoice'</span>,</span><br><span class="line">  <span class="string">'downloadVoice'</span>,</span><br><span class="line">  <span class="string">'chooseImage'</span>,</span><br><span class="line">  <span class="string">'previewImage'</span>,</span><br><span class="line">  <span class="string">'uploadImage'</span>,</span><br><span class="line">  <span class="string">'downloadImage'</span>,</span><br><span class="line">  <span class="string">'getNetworkType'</span>,</span><br><span class="line">  <span class="string">'openLocation'</span>,</span><br><span class="line">  <span class="string">'getLocation'</span>,</span><br><span class="line">  <span class="string">'hideOptionMenu'</span>,</span><br><span class="line">  <span class="string">'showOptionMenu'</span>,</span><br><span class="line">  <span class="string">'closeWindow'</span>,</span><br><span class="line">  <span class="string">'scanQRCode'</span>,</span><br><span class="line">  <span class="string">'chooseWXPay'</span>,</span><br><span class="line">  <span class="string">'openProductSpecificView'</span>,</span><br><span class="line">  <span class="string">'addCard'</span>,</span><br><span class="line">  <span class="string">'chooseCard'</span>,</span><br><span class="line">  <span class="string">'openCard'</span></span><br><span class="line">];</span><br><span class="line"><span class="keyword">const</span> getAccess = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="keyword">async</span> (resolve, reject) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'1321414324324325435'</span>);</span><br><span class="line">    <span class="keyword">const</span> noncestr = crypto.randomBytes(<span class="built_in">Math</span>.ceil(<span class="number">32</span> / <span class="number">2</span>)).toString(<span class="string">'hex'</span>).slice(<span class="number">0</span>, <span class="number">32</span>);;</span><br><span class="line">    <span class="keyword">const</span> timestamp = <span class="built_in">Math</span>.floor(<span class="built_in">Date</span>.now() / <span class="number">1000</span>); <span class="comment">//timestamp</span></span><br><span class="line">    <span class="keyword">let</span> wxdata = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ticket</span></span><br><span class="line">      <span class="keyword">if</span> (cache.get(<span class="string">'ticket'</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'ticket in cache'</span>, cache.get(<span class="string">'ticket'</span>))</span><br><span class="line">        <span class="keyword">const</span> jsapi_ticket = cache.get(<span class="string">'ticket'</span>);</span><br><span class="line">        wxdata = &#123;</span><br><span class="line">          appId: config.wxappid,</span><br><span class="line">          noncestr,</span><br><span class="line">          timestamp,</span><br><span class="line">          url,</span><br><span class="line">          jsapi_ticket,</span><br><span class="line">          signature: sha1(<span class="string">`jsapi_ticket=<span class="subst">$&#123;jsapi_ticket&#125;</span>&amp;noncestr=<span class="subst">$&#123;noncestr&#125;</span>&amp;timestamp=<span class="subst">$&#123;timestamp&#125;</span>&amp;url=<span class="subst">$&#123;url&#125;</span>`</span>),</span><br><span class="line">          jsApiList</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> tokenMap = <span class="keyword">await</span> rp(&#123;<span class="attr">uri</span>: <span class="string">`https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid=<span class="subst">$&#123;config.wxappid&#125;</span>&amp;secret=<span class="subst">$&#123;config.wxappsecret&#125;</span>`</span>&#125;);</span><br><span class="line">        <span class="comment">// console.log('rp res', JSON.parse(tokenMap));</span></span><br><span class="line">        <span class="keyword">const</span> resp = <span class="keyword">await</span> rp(&#123;<span class="attr">uri</span>: <span class="string">`https://api.weixin.qq.com/cgi-bin/ticket/getticket?access_token=<span class="subst">$&#123;<span class="built_in">JSON</span>.parse(tokenMap).access_token&#125;</span>&amp;type=jsapi`</span>&#125;);</span><br><span class="line">        <span class="keyword">const</span> ticketMap = <span class="built_in">JSON</span>.parse(resp);</span><br><span class="line">        <span class="comment">// console.log('ticketMap', ticketMap);</span></span><br><span class="line">        cache.put(<span class="string">'ticket'</span>, ticketMap.ticket, (<span class="number">1000</span> * <span class="number">7200</span>));</span><br><span class="line">        <span class="keyword">var</span> resultCode = sha1(<span class="string">`jsapi_ticket=<span class="subst">$&#123;ticketMap.ticket&#125;</span>&amp;noncestr=<span class="subst">$&#123;noncestr&#125;</span>&amp;timestamp=<span class="subst">$&#123;timestamp&#125;</span>&amp;url=<span class="subst">$&#123;url&#125;</span>`</span>);</span><br><span class="line">        <span class="comment">// console.log('resultCode', `jsapi_ticket=$&#123;ticketMap.ticket&#125;&amp;noncestr=$&#123;noncestr&#125;&amp;timestamp=$&#123;timestamp&#125;&amp;url=$&#123;url&#125;`);</span></span><br><span class="line">        <span class="comment">// console.log('download url', downloadUrl)</span></span><br><span class="line">        wxdata = &#123;</span><br><span class="line">          appId: config.wxappid,</span><br><span class="line">          noncestr,</span><br><span class="line">          timestamp,</span><br><span class="line">          url,</span><br><span class="line">          jsapi_ticket: ticketMap.ticket,</span><br><span class="line">          signature: resultCode,</span><br><span class="line">          jsApiList</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'wx data'</span>, wxdata);</span><br><span class="line">      resolve(wxdata);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'catch exception'</span>, <span class="built_in">JSON</span>.stringify(e));</span><br><span class="line">      reject(<span class="string">'catch exception'</span>, <span class="built_in">JSON</span>.stringify(e));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = getAccess;</span><br></pre></td></tr></table></figure>
<p>参考文档<br><a href="https://www.jianshu.com/p/97729dd2c94d" target="_blank" rel="noopener">https://www.jianshu.com/p/97729dd2c94d</a><br><a href="https://cn.bing.com/search?q=vue+hash%E6%A8%A1%E5%BC%8F%E5%BE%AE%E4%BF%A1%E5%88%86%E4%BA%AB&amp;PC=U316&amp;FORM=CHROMN" target="_blank" rel="noopener">https://cn.bing.com/search?q=vue+hash%E6%A8%A1%E5%BC%8F%E5%BE%AE%E4%BF%A1%E5%88%86%E4%BA%AB&amp;PC=U316&amp;FORM=CHROMN</a></p>
</li>
</ul>
</div><div class="tags"><a href="/tags/vue3-koa2-微信/">vue3 koa2 微信</a></div><div class="post-nav"><a class="pre" href="/2020/07/26/vue首屏白屏分析解决/">vue首屏白屏分析解决</a><a class="next" href="/2020/05/23/vue请求跨域/">vue请求跨域</a></div><div id="lv-container" data-id="city" data-uid="MTAyMC80NTYzNS8yMjE0Ng=="><script>(function(d, s) {
   var j, e = d.getElementsByTagName(s)[0];
   if (typeof LivereTower === 'function') { return; }
   j = d.createElement(s);
   j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
   j.async = true;
   e.parentNode.insertBefore(j, e);
})(document, 'script');
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://www.benyl.cn"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript-html-markdown/">javascript html markdown</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/react/">react</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/webpack/">webpack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/javascript-单链表-leetcode/" style="font-size: 15px;">javascript 单链表 leetcode</a> <a href="/tags/antd-react/" style="font-size: 15px;">antd react</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/javascript-promise/" style="font-size: 15px;">javascript promise</a> <a href="/tags/git-revert/" style="font-size: 15px;">git revert</a> <a href="/tags/javascript-es6/" style="font-size: 15px;">javascript es6</a> <a href="/tags/chrome-cookies/" style="font-size: 15px;">chrome cookies</a> <a href="/tags/node-thrift/" style="font-size: 15px;">node thrift</a> <a href="/tags/javascript-leetcode-算法/" style="font-size: 15px;">javascript leetcode 算法</a> <a href="/tags/javscript-https/" style="font-size: 15px;">javscript https</a> <a href="/tags/javascript-leetcode-链表/" style="font-size: 15px;">javascript leetcode 链表</a> <a href="/tags/vue-单页面应用-请求耗时/" style="font-size: 15px;">vue 单页面应用 请求耗时</a> <a href="/tags/react/" style="font-size: 15px;">react</a> <a href="/tags/javascript-node/" style="font-size: 15px;">javascript node</a> <a href="/tags/leetcode/" style="font-size: 15px;">leetcode</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/javascript-兼容/" style="font-size: 15px;">javascript 兼容</a> <a href="/tags/算法-javascript/" style="font-size: 15px;">算法 javascript</a> <a href="/tags/javaScript-Array/" style="font-size: 15px;">javaScript Array</a> <a href="/tags/koa/" style="font-size: 15px;">koa</a> <a href="/tags/vue-性能优化-白屏/" style="font-size: 15px;">vue 性能优化 白屏</a> <a href="/tags/vue3-axios-跨域/" style="font-size: 15px;">vue3 axios 跨域</a> <a href="/tags/javascript-cheerio-xml-markdown/" style="font-size: 15px;">javascript cheerio xml markdown</a> <a href="/tags/vue3-koa2-微信/" style="font-size: 15px;">vue3 koa2 微信</a> <a href="/tags/React-性能优化-javascript/" style="font-size: 15px;">React 性能优化 javascript</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/11/06/单页面应用打开耗时很慢/">单页面应用打开耗时很慢</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/07/26/vue首屏白屏分析解决/">vue首屏白屏分析解决</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/23/vue3-node-koa-实现微信自定义分享/">vue3+node(koa)实现微信自定义分享</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/05/23/vue请求跨域/">vue请求跨域</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/04/01/git操作之revert/">git操作之revert</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/03/17/samesite/">samesite</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/13/动态菜单获取/">动态菜单获取</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/13/thrift环境搭建/">thrift环境搭建</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/13/爬楼梯/">爬楼梯</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/01/13/react-升级问题汇总/">react 升级问题汇总</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://shimeng.info/" title="小时哥-erics" target="_blank">小时哥-erics</a><ul></ul><a href="https://www.haomwei.com/" title="屠城-屠夫9411的博客" target="_blank">屠城-屠夫9411的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">玉玲～.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>